<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>LayIM测试</title>
    <link rel="stylesheet" href="/layim/build/css/layui.css" media="all">
</head>
<body>
<script src="/layim/build/layui.js"></script>
<script>
    layui.use('layim', function (layim) {

        //基础配置
        layim.config({

            init: {
                url: '/getlist.php' //接口地址（返回的数据格式见下文）
                , type: 'get' //默认get，一般可不填
                , data: {} //额外参数
            } //获取主面板列表信息，下文会做进一步介绍

            //获取群员接口（返回的数据格式见下文）
            , members: {
                url: '/getmember.php' //接口地址（返回的数据格式见下文）
                , type: 'get' //默认get，一般可不填
                , data: {} //额外参数
            }

            //上传图片接口（返回的数据格式见下文），若不开启图片上传，剔除该项即可
            , uploadImage: {
                url: '/upload.php' //接口地址
                , type: 'post' //默认post
            }

            //上传文件接口（返回的数据格式见下文），若不开启文件上传，剔除该项即可
            , uploadFile: {
                url: '/upload.php' //接口地址
                , type: 'post' //默认post
            }
            //扩展工具栏，下文会做进一步介绍（如果无需扩展，剔除该项即可）
            , tool: [{
                alias: 'code' //工具别名
                , title: '代码' //工具名称
                , icon: '&#xe64e;' //工具图标，参考图标文档
            }]

            , msgbox: layui.cache.dir + 'css/modules/layim/html/msgbox.html' //消息盒子页面地址，若不开启，剔除该项即可
            , find: layui.cache.dir + 'css/modules/layim/html/find.html' //发现页面地址，若不开启，剔除该项即可
            , chatLog: '/chatLog.php' //聊天记录页面地址，若不开启，剔除该项即可
        });
        // 创建一个Socket实例
        var socket = new WebSocket('ws://localhost:8282');

        // 打开Socket
        socket.onopen = function (event) {
            // 发送一个初始化消息
            socket.send('I am the client and I\'m listening!');
        };


        // 监听消息
        socket.onmessage = function (res) {
            console.log(res);
            res = JSON.parse(res.data);
            if (res.emit === 'chatMessage') {
                layim.getMessage(res.data); //res.data即你发送消息传递的数据（阅读：监听发送的消息）
            }
        };

        // 监听Socket的关闭
        socket.onclose = function (event) {
            console.log('Client notified socket has closed', event);
        };
        layim.on('online', function (status) {
            console.log(status); //获得online或者hide

            //此时，你就可以通过Ajax将这个状态值记录到数据库中了。
            //服务端接口需自写。
        });
        layim.on('sign', function (value) {
            console.log(value); //获得新的签名

            //此时，你就可以通过Ajax将新的签名同步到数据库中了。
        });
        layim.on('setSkin', function (filename, src) {
            console.log(filename); //获得文件名，如：1.jpg
            console.log(src); //获得背景路径，如：http://res.layui.com/layui/src/css/modules/layim/skin/1.jpg
        });
        layim.on('sendMessage', function (res) {
            console.log(res);
            var mine = res.mine; //包含我发送的消息及我的信息
            //mine的结构如下：
            /*
             {
             avatar: "avatar.jpg" //我的头像
             ,content: "你好吗" //消息内容
             ,id: "100000" //我的id
             ,mine: true //是否我发送的消息
             ,username: "纸飞机" //我的昵称
             }*/
            var to = res.to; //对方的信息
            console.log(res);
            data = {
                type: 'chatMessage' //随便定义，用于在服务端区分消息类型
                , data: res
            };
            /*//to的结构如下：
             {
             avatar: "avatar.jpg",id: "100001"
             ,name: "贤心"
             ,sign: "这些都是测试数据，实际使用请严格按照该格式返回"
             ,type: "friend" //聊天类型，一般分friend和group两种，group即群聊
             ,username: "贤心"
             }*/
            //监听到上述消息后，就可以轻松地发送socket了，如：
            socket.send(JSON.stringify(data));

        });
        layim.on('chatChange', function (obj) {
            console.log(obj);
        });
        // 关闭Socket....
        //socket.close()
    });
</script>
</body>
</html>